package com.sitionix.forgeit.processor;

import com.squareup.javapoet.ClassName;
import com.squareup.javapoet.JavaFile;
import com.squareup.javapoet.TypeSpec;

import javax.annotation.processing.FilerException;
import javax.annotation.processing.Messager;
import javax.annotation.processing.ProcessingEnvironment;
import javax.lang.model.element.Modifier;
import javax.tools.Diagnostic;
import javax.tools.JavaFileObject;
import javax.tools.StandardLocation;
import java.io.IOException;
import java.io.Writer;
import java.util.Set;

final class GeneratedInterfaceEmitter {

    private final ProcessingEnvironment processingEnv;
    private final Messager messager;
    private final ClassName generatedType;

    private boolean featuresGenerated;
    private String lastEmittedSignature = "";

    GeneratedInterfaceEmitter(ProcessingEnvironment processingEnv, Messager messager, ClassName generatedType) {
        this.processingEnv = processingEnv;
        this.messager = messager;
        this.generatedType = generatedType;
    }

    void generateInterface(Set<String> aggregatedSupports) {
        final String signature = String.join("\n", aggregatedSupports);
        if (!this.featuresGenerated) {
            emitInterface(aggregatedSupports, signature);
            return;
        }

        if (!this.lastEmittedSignature.equals(signature)) {
            try {
                this.processingEnv.getFiler()
                        .getResource(StandardLocation.SOURCE_OUTPUT,
                                this.generatedType.packageName(),
                                this.generatedType.simpleName() + ".java")
                        .delete();
            } catch (IOException ignored) {
                // best-effort delete; if it fails we'll try overwriting below
            }
            emitInterface(aggregatedSupports, signature);
        }
    }

    private void emitInterface(Set<String> aggregatedSupports, String signature) {
        final TypeSpec.Builder typeBuilder = TypeSpec.interfaceBuilder(this.generatedType.simpleName())
                .addModifiers(Modifier.PUBLIC)
                .addJavadoc("Generated by {@link $L}.\n", ForgeFeaturesProcessor.class.getName());

        for (final String support : aggregatedSupports) {
            typeBuilder.addSuperinterface(ClassName.bestGuess(support));
        }

        final JavaFile javaFile = JavaFile.builder(this.generatedType.packageName(), typeBuilder.build())
                .skipJavaLangImports(true)
                .build();

        try {
            final JavaFileObject sourceFile = this.processingEnv.getFiler().createSourceFile(
                    this.generatedType.packageName() + "." + this.generatedType.simpleName());
            try (Writer writer = sourceFile.openWriter()) {
                javaFile.writeTo(writer);
            }
            this.featuresGenerated = true;
            this.lastEmittedSignature = signature;
        } catch (FilerException ex) {
            this.messager.printMessage(Diagnostic.Kind.ERROR,
                    "ForgeIT features interface already exists and could not be replaced: " + ex.getMessage());
        } catch (IOException ex) {
            this.messager.printMessage(Diagnostic.Kind.ERROR,
                    "Failed to generate ForgeIT features interface: " + ex.getMessage());
        }
    }
}
