name: Release and Sync Versions

on:
  push:
    branches: [ main ]

permissions:
  contents: write
  packages: write
  pull-requests: write

concurrency:
  group: release-main
  cancel-in-progress: false

jobs:
  release:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven

      - name: Calculate versions
        id: versions
        run: |
          python .github/scripts/version_helper.py export >> "$GITHUB_ENV"
          echo "Release version: ${RELEASE_VERSION}" >> "$GITHUB_STEP_SUMMARY"
          echo "Next development version: ${NEXT_VERSION}" >> "$GITHUB_STEP_SUMMARY"

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Set release version
        run: ./mvnw -B -ntp versions:set -DnewVersion=${RELEASE_VERSION} -DgenerateBackupPoms=false

      - name: Build and verify
        run: ./mvnw -B -ntp clean verify

      - name: Setup Maven settings
        env:
          GH_PACKAGES_TOKEN: ${{ secrets.GH_FORGE_IT_TOKEN }}
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml <<'EOF'
          <settings>
            <servers>
              <server>
                <id>github</id>
                <username>${{ github.actor }}</username>
                <password>${GH_PACKAGES_TOKEN}</password>
              </server>
            </servers>
          </settings>
          EOF

      - name: Deploy release artifacts
        run: ./mvnw -B -ntp -DskipTests deploy

      - name: Commit release version
        run: |
          if ! git diff --quiet; then
            git commit -am "Release ${RELEASE_VERSION}"
            git push origin HEAD:main
          fi

      - name: Tag release
        run: |
          git tag v${RELEASE_VERSION}
          git push origin v${RELEASE_VERSION}

      - name: Prepare next development version
        run: |
          git checkout -b sync/release-${RELEASE_VERSION}
          ./mvnw -B -ntp versions:set -DnewVersion=${NEXT_VERSION} -DgenerateBackupPoms=false
          git commit -am "Prepare next development version ${NEXT_VERSION}"
          git push origin sync/release-${RELEASE_VERSION}

      - name: Open sync pull request
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const releaseVersion = process.env.RELEASE_VERSION;
            const nextVersion = process.env.NEXT_VERSION;
            const head = `sync/release-${releaseVersion}`;
            const base = 'develop';
            const {owner, repo} = context.repo;

            const existing = await github.paginate(github.rest.pulls.list, { owner, repo, head: `${owner}:${head}`, base });
            if (existing.length > 0) {
              core.info('Sync pull request already exists.');
              return;
            }

            await github.rest.pulls.create({
              owner,
              repo,
              head,
              base,
              title: `chore: sync ${releaseVersion} to develop`,
              body: `Updates the develop branch to ${nextVersion} after releasing ${releaseVersion}.`
            });
